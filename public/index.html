<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ALICE BOT</title>
<style>
Â  Â  body {
Â  Â  Â  Â  font-family: 'Orbitron', Arial, sans-serif;
Â  Â  Â  Â  max-width: 800px;
Â  Â  Â  Â  margin: auto;
Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  background-color: black;
Â  Â  Â  Â  color: #ff4d4d;
Â  Â  Â  Â  text-shadow: 0 0 8px #ff0000;
Â  Â  }
Â  Â  h1 {
Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  color: #ff4d4d;
Â  Â  Â  Â  text-shadow: 0 0 15px #ff0000, 0 0 30px #ff3333;
Â  Â  }
Â  Â  #chatbox {
Â  Â  Â  Â  border: 2px solid #ff1a1a;
Â  Â  Â  Â  height: 400px;
Â  Â  Â  Â  overflow-y: scroll;
Â  Â  Â  Â  padding: 15px;
Â  Â  Â  Â  background-color: #111;
Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  margin-bottom: 10px;
Â  Â  Â  Â  transition: box-shadow 0.3s ease-in-out, border-color 0.3s ease-in-out;
Â  Â  }
Â  Â  #chatbox.speaking {
Â  Â  Â  Â  box-shadow: 0 0 25px #ff0000, 0 0 50px #ff1a1a;
Â  Â  }
Â  Â  #chatbox.listening {
Â  Â  Â  Â  box-shadow: 0 0 25px #4dff4d, 0 0 50px #1aff1a;
Â  Â  Â  Â  border-color: #4dff4d;
Â  Â  }
Â  Â  .message {
Â  Â  Â  Â  margin: 5px 0;
Â  Â  Â  Â  padding: 10px 12px;
Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  max-width: 70%;
Â  Â  Â  Â  clear: both;
Â  Â  Â  Â  font-size: 1rem;
Â  Â  }
Â  Â  .user {
Â  Â  Â  Â  background-color: #222;
Â  Â  Â  Â  color: #ff6666;
Â  Â  Â  Â  border: 1px solid #ff3333;
Â  Â  Â  Â  float: right;
Â  Â  Â  Â  text-align: right;
Â  Â  }
Â  Â  .ai {
Â  Â  Â  Â  background-color: #330000;
Â  Â  Â  Â  color: #ffcccc;
Â  Â  Â  Â  border: 1px solid #ff4d4d;
Â  Â  Â  Â  float: left;
Â  Â  }
Â  Â  #controls {
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  gap: 10px;
Â  Â  Â  Â  margin-top: 10px;
Â  Â  Â  Â  flex-wrap: wrap;
Â  Â  }
Â  Â  input {
Â  Â  Â  Â  flex: 1;
Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  border: 1px solid #ff3333;
Â  Â  Â  Â  border-radius: 5px;
Â  Â  Â  Â  background: #111;
Â  Â  Â  Â  color: #ff4d4d;
Â  Â  }
Â  Â  button {
Â  Â  Â  Â  padding: 10px 20px;
Â  Â  Â  Â  background-color: #330000;
Â  Â  Â  Â  color: #ff4d4d;
Â  Â  Â  Â  border: 1px solid #ff3333;
Â  Â  Â  Â  border-radius: 5px;
Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  text-shadow: 0 0 8px #ff0000;
Â  Â  }
Â  Â  button:hover {
Â  Â  Â  Â  background-color: #550000;
Â  Â  Â  Â  box-shadow: 0 0 10px #ff0000;
Â  Â  }
Â  Â  select {
Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  border-radius: 5px;
Â  Â  Â  Â  margin-bottom: 10px;
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  background: #111;
Â  Â  Â  Â  color: #ff4d4d;
Â  Â  Â  Â  border: 1px solid #ff3333;
Â  Â  }
Â  Â  .typing-indicator {
Â  Â  Â  Â  display: inline-flex;
Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  gap: 4px;
Â  Â  Â  Â  padding: 10px 12px;
Â  Â  }
Â  Â  .typing-indicator span {
Â  Â  Â  Â  width: 8px;
Â  Â  Â  Â  height: 8px;
Â  Â  Â  Â  background-color: #ff4d4d;
Â  Â  Â  Â  border-radius: 50%;
Â  Â  Â  Â  animation: bounce 1.2s infinite ease-in-out;
Â  Â  }
Â  Â  .typing-indicator span:nth-child(2) {
Â  Â  Â  Â  animation-delay: -0.2s;
Â  Â  }
Â  Â  .typing-indicator span:nth-child(3) {
Â  Â  Â  Â  animation-delay: -0.4s;
Â  Â  }
Â  Â  @keyframes bounce {
Â  Â  Â  Â  0%, 100% { transform: translateY(0); }
Â  Â  Â  Â  50% { transform: translateY(-5px); }
Â  Â  }
Â  Â  @media (max-width: 600px) {
Â  Â  Â  Â  #chatbox { height: 300px; }
Â  Â  }
</style>
</head>
<body>
<h1>ALICE BOT</h1>

<label for="modelSelect">Choose AI Model:</label>
<select id="modelSelect">
Â  Â  <option value="qwen/qwen-2.5-coder-32b-instruct:free" selected>Qwen 2.5 Coder 32B (Free)</option>
Â  Â  <option value="cognitivecomputations/dolphin-mistral-24b-venice-edition:free">Dolphin Mistral 24B Venice (Free)</option>
Â  Â  <option value="meta-llama/llama-3.2-3b-instruct:free">Llama 3.2 3B (Free)</option>
Â  Â  <option value="mistralai/mistral-7b-instruct">Mistral 7B (Free)</option>
Â  Â  <option value="google/gemma-2-9b-it:free">Google Gemma 2 9B (Free)</option>
Â  Â  <option value="deepseek/deepseek-r1-0528:free">DeepSeek R1 0528 (Free)</option>
Â  Â  <option value="meta-llama/llama-3.3-70b-instruct:free">Llama 3.3 70B (Free)</option>
Â  Â  <option value="tngtech/deepseek-r1t-chimera:free">DeepSeek Chimera (Free)</option>
</select>

<div id="chatbox"></div>

<div id="controls">
Â  Â  <input type="text" id="userInput" placeholder="Type your message...">
Â  Â  <button onclick="sendMessage()">Send</button>
Â  Â  <button onclick="resetChat()">Clear</button>
Â  Â  <button onclick="stopSpeaking()">Stop Voice</button>
Â  Â  <button onclick="startListening()">ðŸŽ¤ Speak</button>
Â  Â  <button onclick="stopListening()">âœ– Stop Listening</button>
</div>

<script>
let sessionId = Date.now().toString();
let isSpeaking = false;
let recognition;

// --- Initialize Speech Recognition if available ---
if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
Â  Â  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
Â  Â  recognition = new SpeechRecognition();
Â  Â  recognition.lang = 'en-US';
Â  Â  recognition.interimResults = false;
Â  Â  recognition.continuous = false;

Â  Â  recognition.onstart = function() {
Â  Â  Â  Â  toggleListeningUI(true);
Â  Â  };
Â  Â  recognition.onend = function() {
Â  Â  Â  Â  toggleListeningUI(false);
Â  Â  };

Â  Â  recognition.onresult = function(event) {
Â  Â  Â  Â  const speechText = event.results[0][0].transcript;
Â  Â  Â  Â  document.getElementById('userInput').value = speechText;
Â  Â  Â  Â  sendMessage();
Â  Â  };

Â  Â  recognition.onerror = function(event) {
Â  Â  Â  Â  console.error('Speech recognition error', event.error);
Â  Â  Â  Â  toggleListeningUI(false);
Â  Â  };
} else {
Â  Â  console.warn("Speech Recognition not supported in this browser.");
Â  Â  // Corrected selectors to hide only the STT buttons
Â  Â  document.querySelector('button[onclick="startListening()"]').style.display = 'none';
Â  Â  document.querySelector('button[onclick="stopListening()"]').style.display = 'none';
}

// --- STT controls ---
function startListening() { recognition?.start(); }
function stopListening() { recognition?.stop(); }

function toggleListeningUI(isListening) {
Â  Â  const chatbox = document.getElementById('chatbox');
Â  Â  const speakButton = document.querySelector('button[onclick="startListening()"]');
Â  Â  if (isListening) {
Â  Â  Â  Â  chatbox.classList.add('listening');
Â  Â  Â  Â  speakButton.textContent = '...Listening';
Â  Â  } else {
Â  Â  Â  Â  chatbox.classList.remove('listening');
Â  Â  Â  Â  speakButton.textContent = 'ðŸŽ¤ Speak';
Â  Â  }
}

// --- Chat & TTS ---
async function sendMessage(retryInput) {
Â  Â  const inputEl = document.getElementById('userInput');
Â  Â  let text = retryInput || inputEl.value.trim();
Â  Â  if (!text) return;

Â  Â  if (!retryInput) addMessage(text, 'user');
Â  Â  inputEl.value = '';

Â  Â  const typingIndicator = addTypingIndicator();

Â  Â  const modelSelect = document.getElementById('modelSelect');

Â  Â  try {
Â  Â  Â  Â  const res = await fetch('/api/chat', {
Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  body: JSON.stringify({ prompt: text, model: modelSelect.value, sessionId })
Â  Â  Â  Â  });
Â  Â  Â  Â  const data = await res.json();

Â  Â  Â  Â  typingIndicator.remove();

Â  Â  Â  Â  if (!res.ok) throw new Error(data.error || 'Unknown error');

Â  Â  Â  Â  // Get the full AI response, which includes the thought process
Â  Â  Â  Â  let fullReply = data.choices[0].message.content;

Â  Â  Â  Â  // Check for the unique marker to separate the thought process from the final reply
Â  Â  Â  Â  let finalReply = fullReply;
Â  Â  Â  Â  const finalResponseMarker = '---FINAL---';
Â  Â  Â  Â  if (fullReply.includes(finalResponseMarker)) {
Â  Â  Â  Â  Â  Â  const parts = fullReply.split(finalResponseMarker);
Â  Â  Â  Â  Â  Â  finalReply = parts[1].trim(); // Get the text after the marker and remove whitespace
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  // If the marker is not found, log a warning and use the full reply
Â  Â  Â  Â  Â  Â  console.warn("Final response marker not found. The full response will be displayed.");
Â  Â  Â  Â  Â  Â  console.log("Full AI response:", fullReply);
Â  Â  Â  Â  Â  Â  finalReply = fullReply;
Â  Â  Â  Â  }

Â  Â  Â  Â  addMessage(finalReply, 'ai');
Â  Â  Â  Â  speakText(finalReply);

Â  Â  } catch (err) {
Â  Â  Â  Â  console.error(err);
Â  Â  Â  Â  typingIndicator.remove();

Â  Â  Â  Â  const options = [...modelSelect.options];
Â  Â  Â  Â  const currentIndex = options.findIndex(opt => opt.value === modelSelect.value);
Â  Â  Â  Â  const nextIndex = (currentIndex + 1) % options.length;
Â  Â  Â  Â  modelSelect.selectedIndex = nextIndex;

Â  Â  Â  Â  addMessage(`Error encountered. Switching model to ${modelSelect.value} and retrying...`, 'ai');
Â  Â  Â  Â  sendMessage(text);
Â  Â  }
}

function addMessage(text, type) {
Â  Â  const chatbox = document.getElementById('chatbox');
Â  Â  const msg = document.createElement('div');
Â  Â  msg.textContent = text;
Â  Â  msg.className = 'message ' + type;
Â  Â  chatbox.appendChild(msg);
Â  Â  chatbox.scrollTop = chatbox.scrollHeight;
Â  Â  return msg;
}

function addTypingIndicator() {
Â  Â  const chatbox = document.getElementById('chatbox');
Â  Â  const typingMsg = document.createElement('div');
Â  Â  typingMsg.className = 'message ai typing-indicator';
Â  Â  typingMsg.innerHTML = '<span></span><span></span><span></span>';
Â  Â  chatbox.appendChild(typingMsg);
Â  Â  chatbox.scrollTop = chatbox.scrollHeight;
Â  Â  return typingMsg;
}

// --- Simplified TTS ---
function speakText(text) {
Â  Â  stopSpeaking();
Â  Â  // This line removes all emojis before the text is spoken
Â  Â  const textWithoutEmojis = text.replace(/\p{Emoji_Presentation}/gu, '');
Â  Â  const utterance = new SpeechSynthesisUtterance(textWithoutEmojis);
Â  Â  const chatbox = document.getElementById('chatbox');
Â  Â  utterance.onstart = () => chatbox.classList.add('speaking');
Â  Â  utterance.onend = () => chatbox.classList.remove('speaking');
Â  Â  speechSynthesis.speak(utterance);
}

function stopSpeaking() {
Â  Â  if (speechSynthesis.speaking) {
Â  Â  Â  Â  speechSynthesis.cancel();
Â  Â  Â  Â  document.getElementById('chatbox').classList.remove('speaking');
Â  Â  }
}

function resetChat() {
Â  Â  document.getElementById('chatbox').innerHTML = '';
Â  Â  stopSpeaking();
Â  Â  fetch('/api/reset', {
Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  body: JSON.stringify({ sessionId })
Â  Â  }).catch(err => console.error('Reset error:', err));
}

// --- Enter key submit, shift+Enter for new line ---
document.getElementById('userInput').addEventListener('keydown', (e) => {
Â  Â  if (e.key === 'Enter' && !e.shiftKey) {
Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  sendMessage();
Â  Â  }
});
</script>
</body>
</html>
