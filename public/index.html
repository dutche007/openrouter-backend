<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ALICE BOT</title>
<style>
    body {
        font-family: 'Orbitron', Arial, sans-serif;
        max-width: 800px;
        margin: auto;
        padding: 20px;
        background-color: black;
        color: #ff4d4d;
        text-shadow: 0 0 8px #ff0000;
    }
    h1 {
        text-align: center;
        color: #ff4d4d;
        text-shadow: 0 0 15px #ff0000, 0 0 30px #ff3333;
    }
    #chatbox {
        border: 2px solid #ff1a1a;
        height: 400px;
        overflow-y: scroll;
        padding: 15px;
        background-color: #111;
        border-radius: 12px;
        margin-bottom: 10px;
        transition: box-shadow 0.3s ease-in-out;
    }
    #chatbox.speaking {
        box-shadow: 0 0 25px #ff0000, 0 0 50px #ff1a1a;
    }
    .message {
        margin: 5px 0;
        padding: 10px 12px;
        border-radius: 8px;
        max-width: 70%;
        clear: both;
        font-size: 1rem;
    }
    .user {
        background-color: #222;
        color: #ff6666;
        border: 1px solid #ff3333;
        float: right;
        text-align: right;
    }
    .ai {
        background-color: #330000;
        color: #ffcccc;
        border: 1px solid #ff4d4d;
        float: left;
    }
    #controls {
        display: flex;
        gap: 10px;
        margin-top: 10px;
        flex-wrap: wrap;
    }
    input {
        flex: 1;
        padding: 10px;
        border: 1px solid #ff3333;
        border-radius: 5px;
        background: #111;
        color: #ff4d4d;
    }
    button {
        padding: 10px 20px;
        background-color: #330000;
        color: #ff4d4d;
        border: 1px solid #ff3333;
        border-radius: 5px;
        cursor: pointer;
        text-shadow: 0 0 8px #ff0000;
    }
    button:hover {
        background-color: #550000;
        box-shadow: 0 0 10px #ff0000;
    }
    select {
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 10px;
        width: 100%;
        background: #111;
        color: #ff4d4d;
        border: 1px solid #ff3333;
    }
    @media (max-width: 600px) {
        #chatbox { height: 300px; }
    }
</style>
</head>
<body>
<h1>ALICE BOT</h1>

<label for="modelSelect">Choose AI Model:</label>
<select id="modelSelect">
    <option value="qwen/qwen-2.5-coder-32b-instruct:free" selected>Qwen 2.5 Coder 32B (Free)</option>
    <option value="cognitivecomputations/dolphin-mistral-24b-venice-edition:free">Dolphin Mistral 24B Venice (Free)</option>
    <option value="meta-llama/llama-3.2-3b-instruct:free">Llama 3.2 3B (Free)</option>
    <option value="mistralai/mistral-7b-instruct">Mistral 7B (Free)</option>
</select>

<div id="chatbox"></div>

<div id="controls">
    <input type="text" id="userInput" placeholder="Type your message...">
    <button onclick="sendMessage()">Send</button>
    <button onclick="resetChat()">Clear</button>
    <button onclick="stopSpeaking()">Stop Voice</button>
    <button onclick="startListening()">ðŸŽ¤ Speak</button>
    <button onclick="stopListening()">âœ– Stop Listening</button>
</div>

<script>
let sessionId = Date.now().toString();
let isSpeaking = false;

// --- Speech-to-Text ---
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
const recognition = new SpeechRecognition();
recognition.lang = 'en-US';
recognition.interimResults = false;
recognition.continuous = false;

function startListening() { recognition.start(); }
function stopListening() { recognition.stop(); }

recognition.onresult = function(event) {
    const speechText = event.results[0][0].transcript;
    document.getElementById('userInput').value = speechText;
    sendMessage();
};

recognition.onerror = function(event) { console.error('Speech recognition error', event.error); };

// --- Chat & TTS ---
async function sendMessage() {
    const input = document.getElementById('userInput');
    const text = input.value.trim();
    const model = document.getElementById('modelSelect').value;
    if (!text) return;

    addMessage(text, 'user');
    input.value = '';

    const typingIndicator = addMessage('AI is typing...', 'ai');

    try {
        const res = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt: text, model: model, sessionId })
        });
        const data = await res.json();
        typingIndicator.remove();

        if (res.ok) {
            let reply = data.choices[0].message.content;
            if (reply.length > 200) reply = reply.split('. ')[0] + '.';
            addMessage(reply, 'ai');
            speakText(reply);
        } else {
            addMessage('Error: ' + (data.error || 'Unknown error'), 'ai');
        }
    } catch (err) {
        typingIndicator.remove();
        addMessage('Error: ' + err.message, 'ai');
    }
}

function addMessage(text, type) {
    const chatbox = document.getElementById('chatbox');
    const msg = document.createElement('div');
    msg.textContent = text;
    msg.className = 'message ' + type;
    chatbox.appendChild(msg);
    chatbox.scrollTop = chatbox.scrollHeight;
    return msg;
}

function speakText(text) {
    stopSpeaking();
    const voices = speechSynthesis.getVoices();
    let voice = voices.find(v => v.name.toLowerCase().includes('male')) || voices[0];

    const utterance = new SpeechSynthesisUtterance(text);
    utterance.voice = voice;
    utterance.pitch = 0.5;
    utterance.rate = 0.85;

    const chatbox = document.getElementById('chatbox');
    utterance.onstart = () => {
        isSpeaking = true;
        chatbox.classList.add('speaking');
    };
    utterance.onend = () => {
        isSpeaking = false;
        chatbox.classList.remove('speaking');
    };

    speechSynthesis.speak(utterance);
}

function stopSpeaking() {
    if (speechSynthesis.speaking) {
        speechSynthesis.cancel();
        document.getElementById('chatbox').classList.remove('speaking');
        isSpeaking = false;
    }
}

async function resetChat() {
    document.getElementById('chatbox').innerHTML = '';
    stopSpeaking();
}

document.getElementById('userInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessage();
});
</script>
</body>
</html>
