<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ALICE BOT</title>
<style>
    body {
        font-family: 'Courier New', Courier, monospace;
        max-width: 800px;
        margin: auto;
        padding: 20px;
        background-color: #000;
        color: #f00;
    }
    h1 {
        text-align: center;
        color: #ff1a1a;
    }
    #modelSelect {
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 10px;
        width: 100%;
        background-color: #111;
        color: #f00;
        border: 1px solid #f00;
    }
    #chatbox {
        border: 1px solid #f00;
        height: 400px;
        overflow-y: scroll;
        padding: 15px;
        background-color: #111;
        border-radius: 8px;
        margin-bottom: 10px;
        transition: box-shadow 0.3s;
    }
    #chatbox.speaking {
        box-shadow: 0 0 20px #ff0000;
    }
    #chatbox p {
        margin: 5px 0;
        padding: 8px;
        border-radius: 5px;
    }
    #chatbox p.user {
        background-color: #330000;
        text-align: right;
        color: #ff6666;
    }
    #chatbox p.ai {
        background-color: #111;
        color: #ff1a1a;
    }
    input {
        width: 60%;
        padding: 10px;
        border: 1px solid #f00;
        border-radius: 5px;
        margin-right: 10px;
        background-color: #000;
        color: #f00;
    }
    button {
        padding: 10px 20px;
        background-color: #111;
        color: #f00;
        border: 1px solid #f00;
        border-radius: 5px;
        cursor: pointer;
    }
    button:hover {
        background-color: #330000;
    }
    @media (max-width: 600px) {
        input { width: 55%; }
        #chatbox { height: 300px; }
    }
</style>
</head>
<body>
<h1>ALICE BOT</h1>
<label for="modelSelect">Choose AI Model:</label>
<select id="modelSelect">
    <option value="qwen/qwen-2.5-coder-32b-instruct:free" selected>Qwen 2.5 Coder 32B (Free)</option>
    <option value="cognitivecomputations/dolphin-mistral-24b-venice-edition:free">Dolphin Mistral 24B Venice (Free)</option>
    <option value="meta-llama/llama-3.2-3b-instruct:free">Llama 3.2 3B (Free)</option>
    <option value="mistralai/mistral-7b-instruct">Mistral 7B (Free)</option>
</select>
<div id="chatbox"></div>
<input type="text" id="userInput" placeholder="Type your message...">
<button onclick="sendMessage()">Send</button>
<button id="sttButton">ðŸŽ¤ Start Listening</button>
<button onclick="stopSpeaking()">Stop TTS</button>

<script>
let isSpeaking = false;
let voices = [];

speechSynthesis.onvoiceschanged = () => {
    voices = speechSynthesis.getVoices();
};

function speakText(text) {
    stopSpeaking();
    if (!voices.length) voices = speechSynthesis.getVoices();
    let voice = voices.find(v => v.name.toLowerCase().includes('male')) || voices[0];
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.voice = voice;
    utterance.pitch = 0.5;
    utterance.rate = 0.85;
    const chatbox = document.getElementById('chatbox');
    utterance.onstart = () => {
        isSpeaking = true;
        chatbox.classList.add('speaking');
    };
    utterance.onend = () => {
        isSpeaking = false;
        chatbox.classList.remove('speaking');
    };
    speechSynthesis.speak(utterance);
}

function stopSpeaking() {
    if (speechSynthesis.speaking) {
        speechSynthesis.cancel();
        isSpeaking = false;
        document.getElementById('chatbox').classList.remove('speaking');
    }
}

document.body.addEventListener('click', () => { voices = speechSynthesis.getVoices(); }, { once: true });

function addMessage(text, type) {
    const chatbox = document.getElementById('chatbox');
    const msg = document.createElement('p');
    msg.textContent = text;
    msg.className = type;
    chatbox.appendChild(msg);
    chatbox.scrollTop = chatbox.scrollHeight;
}

async function sendMessage(userInputValue = null) {
    const inputEl = document.getElementById('userInput');
    const input = userInputValue || inputEl.value;
    const modelSelect = document.getElementById('modelSelect');
    let model = modelSelect.value;
    if (!input) return;
    addMessage('You: ' + input, 'user');
    inputEl.value = '';

    try {
        let response = await fetchChat(model, input);
        addMessage('ALICE: ' + response, 'ai');
        speakText(response);
    } catch (err) {
        console.error("Error, switching model...", err);
        const otherModel = Array.from(modelSelect.options).find(o => o.value !== model).value;
        modelSelect.value = otherModel;
        sendMessage(input); // retry with new model
    }
}

async function fetchChat(model, input) {
    const res = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt: input, model: model })
    });
    if (!res.ok) {
        const err = await res.json();
        throw new Error(err.error?.message || res.status);
    }
    const data = await res.json();
    return data.choices[0].message.content;
}

// STT
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
if (SpeechRecognition) {
    const recognition = new SpeechRecognition();
    recognition.continuous = false;
    recognition.interimResults = false;
    recognition.lang = 'en-US';

    recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        sendMessage(transcript);
    };
    recognition.onerror = (event) => console.error("STT error:", event.error);

    document.getElementById('sttButton').addEventListener('click', () => {
        recognition.start();
    });
} else {
    document.getElementById('sttButton').disabled = true;
    document.getElementById('sttButton').textContent = "STT Not Supported";
}

// Submit on Enter
document.getElementById('userInput').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') sendMessage();
});
</script>
</body>
</html>
